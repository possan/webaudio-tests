<!doctype html>
<html>
<head>
<meta name="viewport" content="width=200">
<link rel="stylesheet" href="style.css" />
<script type="text/javascript" src="buffer-loader.js"></script>
<script type="text/javascript">






var context = new webkitAudioContext();

var compressor = context.createDynamicsCompressor();
compressor.connect(context.destination);





function Song() {
	this.data = {
		tracks: [],
		meta: {
			name: '',
			author: '',
		},
		sequencer: {
			bpm: 130,
			shuffle: 50
		}
	};
	this.dirty = true;
}

Song.prototype.load = function(def) {
}

Song.prototype.save = function(def) {
}


var song = new Song();

song.data.tracks = [
	{
		type: 'sample',
		name: 'Kicker',
		enabled: true,
		sample: { value: 0, expression: '' },
		gate: { value: 0, expression: '' },
		volume: { value: 100, expression: '' },
		speed: { value: 100, expression: '' },
		release: { value: 150, expression: '' },
	},{
		type: 'sample',
		name: 'Bassline 1',
		enabled: true,
		waveform: { value: 1, expression: '' },
		gate: { value: 0, expression: '' },
		volume: { value: 100, expression: '' },
		note: { value: 24, expression: '' },
		cutoff: { value: 5000, expression: '' },
		resonance: { value: 1, expression: '' },
		release: { value: 60, expression: '' },
	}
];





function Mixer() {
}

Mixer.prototype.addInput = function(input) {
}





function Sampler() {
	this.buffers = [];
	this.names = [];
}

Sampler.prototype.load = function(data) {
	var self = this;
	var b = new BufferLoader(
		context,
		data.map(function(item) { return item.url; }),
		function(all) {
			console.log('all loaded.', all);
			self.buffers = all;
		}
	);
	b.load();
	data.forEach(function(item) {
		self.names.push(item.name);
	})
}








function DynamicValue(defaultvalue, interval) {
	this.value = defaultvalue;
	this.expression = '';
	this.fun = null;
	this.interval = interval;
}

DynamicValue.prototype.setFixedValue = function(fix) {
	this.value = fix;
	this.fun = null;
}

DynamicValue.prototype.getFixedValue = function() {
	return this.value;
}

DynamicValue.prototype.setExpression = function(expr) {

	//
	// expr:
	// step % 4 == 0
	//
	// code:
	// function (step, substep, superstep, time) {
	// return (step % 4 == 0)
	// }
	//

	this.fun = 0;
	this.expression = expr;
	try {
		var c = 'return ('+expr+');';
		console.log('Compiling code: '+c);
		var f = new Function(['step', 'substep', 'superstep', 'time'], c);
		this.fun = f;
	}	catch(e) {
		console.error('Compilation error', e);
	}

}

DynamicValue.prototype.evalValue = function(state) {
	if (this.fun) {
		// console.log('calling function', state);
		return this.fun(state.step, state.substep, state.superstep, state.time);
	}
	return this.value;
}






function Track() {
	this.values = [];
	this.resolution = 8;
	this.callback = null;
}

Track.prototype.addValue = function(value, speedy) {
	this.values.push({
		source: value,
		highspeed: speedy,
		value: 0.0,
	});
}

Track.prototype.setResolution = function(res) {
	this.resolution = res;
}

Track.prototype.getResolution = function() {
	return this.resolution;
}

Track.prototype.step = function(state) {
	// console.log('Track step', state);
	var ss = state.superstep;
	// check gate, fire off sound, all values are now evaluated and ready...
	for(var i=0; i<this.values.length; i++) {
		var t = this.values[i];
		t.updated = false;
		if (t.highspeed || (ss % this.resolution) == 0) {
			// console.log('evaluate step, value #', i, state);
			t.value = t.source.evalValue(state);
			t.updated = true;
		}
	}
	if (this.callback)
		this.callback(this, state);
}









function Sequencer() {
	this.bpm = 120;
	this.shuffle = 0;
	this.timeperstep = 0;
	this.timeperstep2 = 0;
	this.supersteps = 8;
	this.halfsupersteps = this.supersteps / 2;
	this.superstep = 0;
	this.progress = 0;
	this.progresstotal = 0;
	this.tracks = [];
}

Sequencer.prototype.addTrack = function(track) {
	this.tracks.push(track);
}

Sequencer.prototype._subtick = function(d) {
	var st = Math.floor(this.superstep / this.supersteps);
	var ss = this.superstep % this.supersteps;
	// if (ss == 0)
	// console.log('subtick', this.superstep, st, ss, d);

	var state = {
		step: st,
		substep: ss,
		superstep: this.superstep,
		time: this.progresstotal / 1000.0
	};

	for (var i=0; i<this.tracks.length; i++) {
		var t = this.tracks[i];
		t.step(state);
	}

	this.superstep += 1;
}

Sequencer.prototype.setBPM = function(bpm) {
	this.bpm = bpm;
	this._updateBPM();
}

Sequencer.prototype.setShuffle = function(shuffle) {
	this.shuffle = shuffle;
	this._updateBPM();
}

Sequencer.prototype._updateBPM = function() {
	var bps = this.bpm / 60.0 * 4.0;
	var tps =  (1000 / bps) / this.supersteps;
	var s = Math.max(-90, Math.min(90, this.shuffle))
	var st = tps * s / 200;
	this.timeperstep = tps + st;
	this.timeperstep2 = tps - st;
	// console.log('time per superstep', this.timeperstep);
}

Sequencer.prototype.play = function() {
	if (this.started)
		return;
	this.started = true;
	this._updateBPM();
	var self = this;
	var lasttick = (new Date()).getTime();
	this.progress = 0;
	this.timer = setInterval(function() {
		var t = (new Date()).getTime();
		var dt = t - lasttick;
		lasttick = t;
		self.progress += dt;
		self.progresstotal += dt;
		var ss = Math.floor(self.superstep / self.supersteps);
		// var sh = self.supersteps / 2;
		var tps = (ss % 2 < 1) ? self.timeperstep : self.timeperstep2;
		if (self.progress < tps)
			return;
		// console.log('tps='+tps);
		self.progress -= tps;
		self._subtick(self.progress);
	}, 1);
}

Sequencer.prototype.stop = function() {
	if (!this.started)
		return;
	this.started = false;
	clearInterval(this.timer);
	this.timer = 0;
}






var mixer = new Mixer();

var sampler = new Sampler();
sampler.load([
	{ url: '808kick3.mp3', name: '808 Kick' },
	{ url: '808snare1.mp3', name: '808 Snare' },
	{ url: '808chh1.mp3', name: '808 Closed Hihat' },
	{ url: '808clap.mp3', name: '808 Clap' },
	{ url: '808kick1.mp3', name: '808 Kick 2' }
]);




function createExpressionEditor(defaultvalue, editorelement) {
	var gatevalue = new DynamicValue(defaultvalue);
	var gateeditor = document.getElementById(editorelement);
	gateeditor.addEventListener('change', function() {
		gatevalue.setExpression(gateeditor.value);
	});
	gatevalue.setExpression(gateeditor.value);
	return gatevalue;
}




function createSampleTrack(gateid, volid, speedid, indicatorid, waveid, relid, sampler) {

	var gatevalue = createExpressionEditor(0, gateid);
	var volvalue = createExpressionEditor(100, volid);
	var speedvalue = createExpressionEditor(100, speedid);
	var wavevalue = createExpressionEditor(0, waveid);
	var relvalue = createExpressionEditor(100, relid);

	var gateindicator = document.getElementById(indicatorid);

	var t = new Track();
	t.addValue(gatevalue, false); // gate
	t.addValue(volvalue, false); // volume
	t.addValue(speedvalue, false); // speed
	t.addValue(wavevalue, false); // wave
	t.addValue(relvalue, false); // release

	t.callback = function(t2, state) {
		// console.log('sample track step', state);
		// console.log('gate=', t2.values[0].value);
		// console.log('vol=', t2.values[1].value);
		// console.log('speed=', t2.values[2].value);
		if (t2.values[0].updated && t2.values[0].value > 0.0) {
			// if (state.superstep % 8 == 0) {
			// console.log('trigger sample.', t2, state);

			gateindicator.className = 'indicator on';
			var source = context.createBufferSource();
			var w = Math.floor(t2.values[3].value);
  	  source.buffer = sampler.buffers[w % sampler.buffers.length];
  	  source.playbackRate.value = t2.values[2].value / 100.0;
			source.loop = false;

			var release = 1.0 * t2.values[4].value;
			var gainNode = context.createGainNode();
    	gainNode.gain.setValueAtTime(t2.values[1].value / 100.0, context.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.0, context.currentTime + release / 1000.0);
			source.connect(gainNode);

			gainNode.connect(compressor);

			source.noteOn(0.0);
			setTimeout(function() {
				source.noteOff(0);
			}, 1000);
		}
		else
			gateindicator.className = 'indicator';
	};

	return t;
}

function createSynthTrack(gateid, noteid, cutoffid, volid, resid, waveid, relid, indicatorid) {

	var filter = context.createBiquadFilter();
	filter.type = 0;
  filter.frequency.value = 0.0;
	filter.connect(compressor);

	var gatevalue = createExpressionEditor(0, gateid);
	var notevalue = createExpressionEditor(36, noteid);
	var cutvalue = createExpressionEditor(20000, cutoffid);
	var resvalue = createExpressionEditor(0, resid);
	var relvalue = createExpressionEditor(100, relid);
	var volvalue = createExpressionEditor(100, volid);
	var wavevalue = createExpressionEditor(0, waveid);

	var gateindicator = document.getElementById(indicatorid);

	var t = new Track();
	t.addValue(gatevalue, false); // gate
	t.addValue(notevalue, false); // note
	t.addValue(cutvalue, true); // cutoff
	t.addValue(resvalue, true); // resonance
	t.addValue(relvalue, false); // release
	t.addValue(volvalue, false); // volume
	t.addValue(wavevalue, false); // wave

	t.callback = function(t2, state) {
		//		console.log('synth track step', state);
		//		console.log('gate=', t2.values[0].value);
		//		console.log('note=', t2.values[1].value);
		//		console.log('cut=', t2.values[2].value);
		//		console.log('rez=', t2.values[3].value);
		//		console.log('release=', t2.values[4].value);
		//		if (t2.values[0].updated) {

		if(t2.values[2].updated) {
			// console.log('cut='+t2.values[2].value);
		  filter.frequency.value = t2.values[2].value;
		  filter.Q.value = t2.values[3].value;
		}

		if (t2.values[0].updated &&
			t2.values[0].value > 0.0) {
			var note = Math.round(t2.values[1].value);
			var freq = 440.0*Math.pow(2.0, (note-49.0)/12.0);
			// console.log('note='+note+', freq='+freq);

			// console.log('trigger synth.', t2, state);

			var source = context.createOscillator();
			source.type = t2.values[6].value;
			source.frequency.value = freq;

			var release = 1.0 * t2.values[4].value;
			var gainNode = context.createGainNode();
    	gainNode.gain.setValueAtTime(t2.values[5].value / 100.0, context.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.0, context.currentTime + release / 1000.0);
			source.connect(gainNode);

			gainNode.connect(filter);

 			gateindicator.className = 'indicator on';
			source.noteOn(0);
			setTimeout(function() {
	 			gateindicator.className = 'indicator';
				source.noteOff(0);
			}, release);
		}
	};
	return t;
}














	function ValueEditor(opts) {
		this.title = '';
		this.type = '';
		this.track = null;
		this.property = '';
		this.path = '';
		this.value = '';
		this.showexpression = true;
		this.expression = '';

		if (opts) {
			this.type = opts.type || '';
			this.title = opts.title || '';
			this.path = opts.path || '';
			this.track = opts.track || null;
			this.property = opts.property || 'x';
		}

		this.node = null;
	}

	ValueEditor.prototype.create = function() {
		var self = this;
		this.node = document.createElement('div');
		this.node.className = 'value';

		if (this.track) {
			if (this.track[this.property]) {
				this.expression = this.track[this.property].expression;
				this.value = this.track[this.property].value;
			}
		}

		var t = document.createElement('h4');
		t.textContent = this.title;
		this.node.appendChild(t);

		var e = document.createElement('textarea');
		e.value = this.expression;
		this.node.appendChild(e);
		e.addEventListener('change', function() {
			console.log('property',self.property,'set to', e.value);
			self.track[self.property] = e.value;
			song.dirty = true;
		});


		return this.node;
	}






	function SampleUI(song, trackindex) {
		this.song = song;
		this.index = trackindex;
		this.node = null;
	}

	SampleUI.prototype.create = function() {
		var track = song.data.tracks[this.index];
		this.node = document.createElement('article');
		var t = document.createElement('h2');
		t.textContent = 'Sampler';
		this.node.appendChild(t);

		this.waveeditor = new ValueEditor({
			type:'sample',
			title:'Sample #',
			track: track,
			property: 'sample'
		});

		this.gateeditor = new ValueEditor({
			type:'gate',
			title:'Gate',
			track: track,
			property: 'gate'
		});

		this.volumeeditor = new ValueEditor({
			type:'%',
			unit:'%',
			title: 'Volume',
			track: track,
			property: 'volume'
		});

		this.releaseeditor = new ValueEditor({
			type:'ms',
			unit:'ms',
			title: 'Release time',
			track: track,
			property: 'release'
		});

		this.speededitor = new ValueEditor({
			type:'%',
			unit:'%',
			title: 'Playback speed',
			track: track,
			property: 'speed'
		});

		this.node.appendChild(this.waveeditor.create());
		this.node.appendChild(this.gateeditor.create());
		this.node.appendChild(this.volumeeditor.create());
		this.node.appendChild(this.releaseeditor.create());
		this.node.appendChild(this.speededitor.create());

		return this.node;
	}












	function SynthUI(song, trackindex) {
		this.song = song;
		this.index = trackindex;
		this.node = null;
	}

	SynthUI.prototype.create = function() {
		var track = song.data.tracks[this.index];
		this.node = document.createElement('article');
		var t = document.createElement('h2');
		t.textContent = 'Synth';
		this.node.appendChild(t);

		this.gateeditor = new ValueEditor({type:'gate', title:'Gate', });
		this.noteeditor = new ValueEditor({type:'note', title:'Note'});
		this.volumeeditor = new ValueEditor({type:'%', unit:'%', title: 'Volume'});
		this.releaseeditor = new ValueEditor({type:'ms', unit:'ms', title: 'Release time'});
		this.cutoffeditor = new ValueEditor({type:'hz', unit:'hz', title: 'Cutoff'});
		this.resoeditor = new ValueEditor({type:'%', unit:'%', title: 'Resonance'});
		this.waveeditor = new ValueEditor({type:'sample', title:'Sample #'});

		this.node.appendChild(this.gateeditor.create());
		this.node.appendChild(this.noteeditor.create());
		this.node.appendChild(this.volumeeditor.create());
		this.node.appendChild(this.releaseeditor.create());
		this.node.appendChild(this.cutoffeditor.create());
		this.node.appendChild(this.resoeditor.create());
		this.node.appendChild(this.waveeditor.create());

		return this.node;
	}











	function init() {

		var seq = new Sequencer();
		seq.setBPM(130.0);
		seq.setShuffle(50);

		var bpmfield = document.getElementById('bpm');
		var shufflefield = document.getElementById('shuffle');

		document.getElementById('play').addEventListener('click', function() {
			var v = document.getElementById('bpm').value;
			seq.setBPM(0.0 + parseFloat(bpmfield.value));
			seq.setShuffle(0.0 + parseFloat(shufflefield.value));
			seq.play();
		});

		document.getElementById('stop').addEventListener('click', function() {
			seq.stop();
		});

		bpmfield.addEventListener('change', function() {
			seq.setBPM(0.0 + parseFloat(bpmfield.value));
		});

		shufflefield.addEventListener('change', function() {
			seq.setShuffle(0.0 + parseFloat(shufflefield.value));
		});





		var groups = document.getElementById('groups');

		var sample1 = new SampleUI(song, 0);
		sample1.create();	
		groups.appendChild(sample1.node);

		var sample2 = new SampleUI(song, 1);
		sample2.create();
		groups.appendChild(sample2.node);

		var synth1 = new SynthUI(song, 2);
		synth1.create();
		groups.appendChild(synth1.node);

		var synth2 = new SynthUI(song, 3);
		synth2.create();
		groups.appendChild(synth2.node);





		setTimeout(function() {
			if (!song.dirty)
				return;
			song.dirty = false;
			document.getElementById('json').value = JSON.stringify(song.data, null, 2);
		}, 500);



		/*



		var	lane1 = createSampleTrack(
			'lane1',
			'lane1vol',
			'lane1speed',
			'lane1indicator',
			'lane1sample',
			'lane1release',
			sampler);
		seq.addTrack(lane1);

		var	lane2 = createSampleTrack(
			'lane2',
			'lane2vol',
			'lane2speed',
			'lane2indicator',
			'lane2sample',
			'lane2release',
			sampler);
		seq.addTrack(lane2);

		var lane3 = createSampleTrack(
			'lane3',
			'lane3vol',
			'lane3speed',
			'lane3indicator',
			'lane3sample',
			'lane3release',
			sampler);
		seq.addTrack(lane3);

		var lane4 = createSampleTrack(
			'lane4',
			'lane4vol',
			'lane4speed',
			'lane4indicator',
			'lane4sample',
			'lane4release',
			sampler);
		seq.addTrack(lane4);

		var bass1 = createSynthTrack(
			'bass1',
			'bass2',
			'bass3',
			'bass4',
			'bass5',
			'bass6',
			'bass7',
			'bassindicator');
		seq.addTrack(bass1);
		*/


	}








</script>
</head>
<body onload="init();">

	<h1>Expression drum machine + synth</h1>

	<section class="sequencer" id="sequencer">

	<button id="play">PLAY</button>
	<button id="stop">STOP</button>
	&nbsp;
	bpm:
	<input id="bpm" value="130" size="4"></input>
	shuffle:
	<input id="shuffle" value="50" size="3"></input>%
</section>

	<section class="groups" id="groups">
<!--
		<article>
			<div id="lane1indicator" class="indicator"></div>
			<p>
				Sample: (0-7)<br/>
				<textarea id="lane1sample" rows="3" cols="50">(0)</textarea>
			</p>
			<p>
				Gate: (0-1)<br/>
				<textarea id="lane1" rows="3" cols="50">(step % 16 == 0) || (step % 16 == 10)</textarea>
			</p>
			<p>
				Volume: (%)<br/>
				<textarea id="lane1vol" rows="3" cols="50">150</textarea>
			</p>
			<p>
				Playback speed: (%)<br/>
				<textarea id="lane1speed" rows="3" cols="50">125</textarea>
			</p>
			<p>
				Release time: (ms)<br/>
				<textarea id="lane1release" rows="5" cols="50">150</textarea>
			</p>
		</article>

		<article>
			<div id="lane2indicator" class="indicator"></div>
			<p>
				Sample: (0-7)<br/>
				<textarea id="lane2sample" rows="3" cols="50">(1)</textarea>
			</p>
			<p>
				Gate: (0-1)<br/>
				<textarea id="lane2" rows="3" cols="50">(step % 8 == 4)</textarea>
			</p>
			<p>
				Volume: (%)<br/>
				<textarea id="lane2vol" rows="3" cols="50">150</textarea>
			</p>
			<p>
				Playback speed: (%)<br/>
				<textarea id="lane2speed" rows="3" cols="50">40</textarea>
			</p>
			<p>
				Release time: (ms)<br/>
				<textarea id="lane2release" rows="5" cols="50">200</textarea>
			</p>
		</article>

		<article>
			<div id="lane3indicator" class="indicator"></div>
			<p>
				Sample: (0-7)<br/>
				<textarea id="lane3sample" rows="3" cols="50">(2)</textarea>
			</p>
			<p>
				Gate: (0-1)<br/>
				<textarea id="lane3" rows="3" cols="50">step % 8 &gt; 4</textarea>
			</p>
			<p>
				Volume: (%)<br/>
				<textarea id="lane3vol" rows="3" cols="50">50</textarea>
			</p>
			<p>
				Playback speed: (%)<br/>
				<textarea id="lane3speed" rows="3" cols="50">100</textarea>
			</p>
			<p>
				Release time: (ms)<br/>
				<textarea id="lane3release" rows="5" cols="50">350</textarea>
			</p>
		</article>

		<article>
			<div id="lane4indicator" class="indicator"></div>
			<p>
				Sample: (0-7)<br/>
				<textarea id="lane4sample" rows="3" cols="50">(3)</textarea>
			</p>
			<p>
				Gate: (0-1)<br/>
				<textarea id="lane4" rows="3" cols="50">step % 32 == 8</textarea>
			</p>
			<p>
				Volume: (%)<br/>
				<textarea id="lane4vol" rows="3" cols="50">100</textarea>
			</p>
			<p>
				Playback speed: (%)<br/>
				<textarea id="lane4speed" rows="3" cols="50">150</textarea>
			</p>
			<p>
				Release time: (ms)<br/>
				<textarea id="lane4release" rows="5" cols="50">40</textarea>
			</p>
		</article>

		<article>
			<h3>Bass:</h3>
			<div id="bassindicator" class="indicator"></div>
			<p>
				Waveform: (0 - 3)<br/>
				<textarea id="bass6" rows="5" cols="50">3</textarea>
			</p>
			<p>
				Gate: (0 - 1)<br/>
				<textarea id="bass1" rows="5" cols="50">step % 4 != 1</textarea>
			</p>
			<p>
				Note: (midi key)<br/>
				<textarea id="bass2" rows="5" cols="50">((step % 4) &lt; 2) ?  12 : 24</textarea>
			</p>
			<p>
				Cutoff freq: (hz)<br/>
				<textarea id="bass3" rows="5" cols="50">3000 + (2000 * Math.sin(time * 1.3))</textarea>
			</p>
			<p>
				Resonance: (0-1+)<br/>
				<textarea id="bass5" rows="5" cols="50">2.5</textarea>
			</p>
			<p>
				Volume: (%)<br/>
				<textarea id="bass4" rows="5" cols="50">100</textarea>
			</p>
			<p>
				Release time: (ms)<br/>
				<textarea id="bass7" rows="5" cols="50">70</textarea>
			</p>
		</article>
-->
	</section>

	<hr/>

	<textarea id="json" rows="40" cols="150"></textarea>

</body>
</html>
